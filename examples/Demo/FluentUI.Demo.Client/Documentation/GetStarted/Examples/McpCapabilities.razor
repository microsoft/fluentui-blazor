@using FluentUI.Mcp.Shared
@inject HttpClient Http

@if (_loading)
{
    <FluentSpinner />
}
else if (_summary is null)
{
    <FluentMessageBar Title="Error" Intent="MessageBarIntent.Error">
        Failed to load MCP capabilities data.
    </FluentMessageBar>
}
else
{
    <FluentTabs @bind-ActiveTabId="@_activeTab">
        <FluentTab Id="tools" Header="@($"Tools ({_summary.Tools.Count})")">
            <FluentDataGrid Items="@_summary.Tools.AsQueryable()" GridTemplateColumns="1fr 2fr 1fr">
                <PropertyColumn Property="@(t => t.Name)" Title="Name" />
                <PropertyColumn Property="@(t => t.Description)" Title="Description" />
                <TemplateColumn Title="Parameters">
                    @if (context.Parameters.Count > 0)
                    {
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="0">
                            @foreach (var param in context.Parameters)
                            {
                                <span>
                                    <code>@param.Name</code>
                                    <span class="text-muted">(@param.Type)</span>
                                    @if (param.Required)
                                    {
                                        <span>*</span>
                                    }
                                </span>
                            }
                        </FluentStack>
                    }
                    else
                    {
                        <span class="text-muted">None</span>
                    }
                </TemplateColumn>
            </FluentDataGrid>
        </FluentTab>

        <FluentTab Id="prompts" Header="@($"Prompts ({_summary.Prompts.Count})")">
            <FluentDataGrid Items="@_summary.Prompts.AsQueryable()" GridTemplateColumns="1fr 2fr 1fr">
                <PropertyColumn Property="@(p => p.Name)" Title="Name" />
                <PropertyColumn Property="@(p => p.Description)" Title="Description" />
                <TemplateColumn Title="Parameters">
                    @if (context.Parameters.Count > 0)
                    {
                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="0">
                            @foreach (var param in context.Parameters)
                            {
                                <span>
                                    <code>@param.Name</code>
                                    <span class="text-muted">(@param.Type)</span>
                                    @if (param.Required)
                                    {
                                        <span>*</span>
                                    }
                                </span>
                            }
                        </FluentStack>
                    }
                    else
                    {
                        <span class="text-muted">None</span>
                    }
                </TemplateColumn>
            </FluentDataGrid>
        </FluentTab>

        <FluentTab Id="resources" Header="@($"Resources ({_summary.Resources.Count})")">
            <FluentDataGrid Items="@_summary.Resources.AsQueryable()" GridTemplateColumns="1fr 1fr 2fr 0.5fr">
                <PropertyColumn Property="@(r => r.Uri)" Title="URI" />
                <PropertyColumn Property="@(r => r.Title)" Title="Title" />
                <PropertyColumn Property="@(r => r.Description)" Title="Description" />
                <TemplateColumn Title="Type">
                    @if (context.IsTemplate)
                    {
                        <span class="text-muted">Template</span>
                    }
                    else
                    {
                        <span class="text-muted">Static</span>
                    }
                </TemplateColumn>
            </FluentDataGrid>
        </FluentTab>
    </FluentTabs>
}

@code {
    private string _activeTab = "tools";
    private McpSummary? _summary;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Try to get from static cache first (works in Server mode)
            if (McpCapabilitiesData.IsInitialized)
            {
                _summary = McpCapabilitiesData.GetSummary();
            }
            else
            {
                // Fetch from API (for WebAssembly mode)
                _summary = await Http.GetFromJsonAsync<McpSummary>("/api/mcp/capabilities");
            }
        }
        catch
        {
            _summary = null;
        }
        finally
        {
            _loading = false;
        }
    }
}
