<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFrameworks>$(TargetNetVersions)</TargetFrameworks>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <LangVersion>latest</LangVersion>
    <SignAssembly>False</SignAssembly>
    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <WarningsNotAsErrors>612,618</WarningsNotAsErrors>
    <RootNamespace>Microsoft.FluentUI.AspNetCore.McpServer</RootNamespace>

    <PackageId>Microsoft.FluentUI.AspNetCore.McpServer</PackageId>
    <Title>Microsoft Fluent UI Blazor MCP Server</Title>
    <PackageReadmeFile>README.md</PackageReadmeFile>
    <PackageIcon>icon.png</PackageIcon>
    <Summary>MCP server for Fluent UI Blazor component documentation. Provides AI assistants with access to component details, parameters, events, methods,and enums.</Summary>
    <Description>MCP (Model Context Protocol) server for Fluent UI Blazor component documentation. Provides AI assistants with access to component details, parameters, events, methods,and enums.</Description>
    <PackageTags>mcp;model-context-protocol;fluent-ui;blazor;documentation;ai;copilot</PackageTags>

    <!-- Configure as .NET Tool for NuGet -->
    <PackAsTool>true</PackAsTool>
    <ToolCommandName>fluentui-mcp</ToolCommandName>

    <!-- MCP Server package type for NuGet discovery -->
    <PackageType>McpServer</PackageType>

    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <IsPackable>true</IsPackable>

    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <DebugType>embedded</DebugType>

    <PackageOutputPath>$(SolutionDir)artifacts</PackageOutputPath>

    <!-- Write the generated files to a specific folder -->
    <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>

    <!-- Path to the generated documentation JSON file -->
    <McpDocumentationJsonPath>$(MSBuildThisFileDirectory)FluentUIComponentsDocumentation.json</McpDocumentationJsonPath>
  </PropertyGroup>

  <!-- Expose internals to test project -->
  <ItemGroup>
    <InternalsVisibleTo Include="Microsoft.FluentUI.AspNetCore.McpServer.Tests" />
  </ItemGroup>

  <!-- Release -->
  <PropertyGroup Condition="'$(Configuration)'=='Release'">
    <Optimize>True</Optimize>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
  </PropertyGroup>

  <!-- Enable deterministic builds for CI environments and Release configuration -->
  <PropertyGroup Condition="'$(GITHUB_ACTIONS)' == 'true' Or '$(TF_BUILD)' == 'true' Or '$(Configuration)' == 'Release'">
    <ContinuousIntegrationBuild>true</ContinuousIntegrationBuild>
  </PropertyGroup>

  <!-- Include README and MCP server manifest in package -->
  <ItemGroup>
    <None Include="README.md" Pack="true" PackagePath="\" />
    <None Include=".mcp\server.json" Pack="true" PackagePath=".mcp\" />
    <None Include="..\..\..\icon.png" Pack="true" PackagePath="\" />
  </ItemGroup>

  <!-- Embed the pre-generated JSON documentation as a resource -->

  <!-- Include Documentation markdown files as embedded resources -->
  <ItemGroup>
    <EmbeddedResource Include="..\..\..\examples\Demo\FluentUI.Demo.Client\Documentation\GetStarted\**\*.md"
                      Exclude="..\..\..\examples\Demo\FluentUI.Demo.Client\Documentation\GetStarted\mcp\**\*"
                      Link="Documentation\GetStarted\%(RecursiveDir)%(Filename)%(Extension)" />
  </ItemGroup>

  <!-- Include Component documentation markdown files and Razor examples as embedded resources -->
  <ItemGroup>
    <EmbeddedResource Include="..\..\..\examples\Demo\FluentUI.Demo.Client\Documentation\Components\**\*.md"
                      Link="Documentation\Components\%(RecursiveDir)%(Filename)%(Extension)" />
    <EmbeddedResource Include="..\..\..\examples\Demo\FluentUI.Demo.Client\Documentation\Components\**\Examples\**\*.razor"
                      Link="Documentation\Components\%(RecursiveDir)%(Filename)%(Extension)" />
    <EmbeddedResource Include="..\..\..\examples\Demo\FluentUI.Demo.Client\Documentation\Components\**\Examples\**\*.cs"
                      Link="Documentation\Components\%(RecursiveDir)%(Filename)%(Extension)" />
  </ItemGroup>

  <!-- Code Analysis -->
  <ItemGroup>
    <PackageReference Include="Microsoft.VisualStudio.Threading.Analyzers">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Meziantou.Analyzer">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <!-- MCP SDK -->
  <ItemGroup>
    <PackageReference Include="ModelContextProtocol" />
  </ItemGroup>

  <!-- Dependencies - Note: LoxSmoke.DocXml is no longer needed -->
  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Components.Web" />
    <PackageReference Include="Microsoft.Extensions.Hosting" />
  </ItemGroup>

  <!-- Reference to the FluentUI Components for API extraction (still needed for type information) -->
  <ItemGroup>
    <ProjectReference Include="..\..\Core\Microsoft.FluentUI.AspNetCore.Components.csproj" />
  </ItemGroup>

  <!-- Exclude duplicate XML documentation file -->
  <ItemGroup>
    <Content Remove="..\..\Tools\FluentUI.Demo.DocApiGen\Microsoft.FluentUI.AspNetCore.Components.xml" />
  </ItemGroup>

  <!-- Embed the generated JSON documentation file as a resource (added dynamically to handle multi-target timing) -->
  <Target Name="AddJsonEmbeddedResource" BeforeTargets="PrepareForBuild" Condition="Exists('$(McpDocumentationJsonPath)')">
    <ItemGroup>
      <EmbeddedResource Include="FluentUIComponentsDocumentation.json" />
    </ItemGroup>
  </Target>

  <Target Name="PostBuild" AfterTargets="PostBuildEvent" Condition="'$(TargetFramework)' == '$(NetVersion)'">
    <ItemGroup>
      <XmlFiles Include="$(ProjectDir)bin\$(Configuration)\$(NetVersion)\*.xml" />
    </ItemGroup>
    <Copy SourceFiles="@(XmlFiles)" DestinationFolder="$(SolutionDir)examples\Tools\FluentUI.Demo.DocApiGen" />
  </Target>

  <!--
    PreBuild target to generate the MCP documentation JSON.
    This runs DocApiGen to extract documentation from the FluentUI Components assembly
    and creates a JSON file that is then embedded as a resource.
  -->
  <Target Name="GenerateMcpDocumentation" BeforeTargets="BeforeBuild" Condition="'$(TargetFramework)' == '$(NetVersion)' AND (!Exists('$(McpDocumentationJsonPath)') OR '$(ForceGenerateMcpDocs)' == 'true')">
    <PropertyGroup>
      <DocApiGenProject>$(MSBuildThisFileDirectory)..\..\..\examples\Tools\FluentUI.Demo.DocApiGen\FluentUI.Demo.DocApiGen.csproj</DocApiGenProject>
      <FluentUIComponentsDll>$(MSBuildThisFileDirectory)..\..\Core\bin\$(Configuration)\$(NetVersion)\Microsoft.FluentUI.AspNetCore.Components.dll</FluentUIComponentsDll>
      <FluentUIComponentsXml>$(MSBuildThisFileDirectory)..\..\Core\bin\$(Configuration)\$(NetVersion)\Microsoft.FluentUI.AspNetCore.Components.xml</FluentUIComponentsXml>
    </PropertyGroup>

    <Message Text="Generating MCP documentation JSON... TargetFramework=$(TargetFramework)" Importance="high" />

    <!-- Build the FluentUI Components first to ensure DLL and XML exist -->
    <MSBuild Projects="$(MSBuildThisFileDirectory)..\..\Core\Microsoft.FluentUI.AspNetCore.Components.csproj" Targets="Build" Properties="Configuration=$(Configuration)" />

    <!-- Restore and Build DocApiGen -->
    <MSBuild Projects="$(DocApiGenProject)" Targets="Restore" Properties="Configuration=$(Configuration)" />
    <MSBuild Projects="$(DocApiGenProject)" Targets="Build" Properties="Configuration=$(Configuration)" />

    <!-- Run DocApiGen to generate MCP JSON -->
    <Exec Command="dotnet run --project &quot;$(DocApiGenProject)&quot; --no-build -c $(Configuration) -- --xml &quot;$(FluentUIComponentsXml)&quot; --dll &quot;$(FluentUIComponentsDll)&quot; --output &quot;$(McpDocumentationJsonPath)&quot; --format json --mode all" WorkingDirectory="$(MSBuildThisFileDirectory)" ConsoleToMSBuild="true" />

    <Message Text="MCP documentation JSON generated at $(McpDocumentationJsonPath)" Importance="high" />
  </Target>

  <!--
    Outer-build target: Generate JSON before dispatching to inner builds (multi-target).
    This ensures FluentUIComponentsDocumentation.json exists for ALL target frameworks.
    Runs only during multi-target builds (when TargetFramework is empty).
  -->
  <Target Name="GenerateMcpDocumentationBeforeDispatch"
          BeforeTargets="DispatchToInnerBuilds"
          Condition="'$(TargetFramework)' == '' AND (!Exists('$(McpDocumentationJsonPath)') OR '$(ForceGenerateMcpDocs)' == 'true')">
    <Message Text="Generating MCP documentation JSON before multi-target dispatch..." Importance="high" />
    <MSBuild Projects="$(MSBuildProjectFile)"
             Targets="GenerateMcpDocumentation"
             Properties="TargetFramework=$(NetVersion);Configuration=$(Configuration)" />
  </Target>

  <!-- Clean target to remove generated documentation -->
  <Target Name="CleanMcpDocumentation" AfterTargets="Clean">
    <Message Text="Cleaning MCP documentation JSON at $(McpDocumentationJsonPath)..." Importance="high" Condition="Exists('$(McpDocumentationJsonPath)')" />
    <Delete Files="$(McpDocumentationJsonPath)" Condition="Exists('$(McpDocumentationJsonPath)')" />
    <Message Text="MCP documentation JSON cleaned." Importance="high" Condition="Exists('$(McpDocumentationJsonPath)')" />
  </Target>

  <!--
    Inline task for reliable version replacement in server.json.
    Uses C# code to read, regex-replace, and write the file preserving formatting.
  -->
  <UsingTask TaskName="ReplaceVersionInJsonFile" TaskFactory="RoslynCodeTaskFactory"
             AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll">
    <ParameterGroup>
      <SourceFile ParameterType="System.String" Required="true" />
      <DestinationFile ParameterType="System.String" Required="true" />
      <NewVersion ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Code Type="Fragment" Language="cs">
        var content = System.IO.File.ReadAllText(SourceFile);
        content = System.Text.RegularExpressions.Regex.Replace(
            content,
            @"""version"":\s*""[^""]*""",
            $@"""version"": ""{NewVersion}""");
        var dir = System.IO.Path.GetDirectoryName(DestinationFile);
        if (!string.IsNullOrEmpty(dir) &amp;&amp; !System.IO.Directory.Exists(dir))
            System.IO.Directory.CreateDirectory(dir);
        System.IO.File.WriteAllText(DestinationFile, content);
      </Code>
    </Task>
  </UsingTask>

  <!--
    Target to stamp version in .mcp/server.json before build and pack.
    Replaces all "version": "..." entries with the current $(Version) in-place.
    The source file uses "0.0.1" as a placeholder; the actual version is set during build.
    Runs once per build (for the primary target framework only).
    In CI, the working tree is disposable. For local Release builds, use 'git checkout' to restore.
  -->
  <Target Name="UpdateMcpServerJsonVersion" BeforeTargets="BeforeBuild"
          Condition="'$(TargetFramework)' == '$(NetVersion)' AND '$(Configuration)' == 'Release'">
    <PropertyGroup>
      <McpServerJsonPath>$(MSBuildThisFileDirectory).mcp\server.json</McpServerJsonPath>
    </PropertyGroup>

    <ReplaceVersionInJsonFile SourceFile="$(McpServerJsonPath)"
                              DestinationFile="$(McpServerJsonPath)"
                              NewVersion="$(Version)" />

    <Message Text="Updated .mcp/server.json version to $(Version)" Importance="high" />
  </Target>

</Project>
