<Project Sdk="Microsoft.NET.Sdk.Razor">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <PackageId>Microsoft.FluentUI.AspNetCore.Components</PackageId>

    <Summary>A set of Blazor components wrapping Microsoft’s official Fluent UI Web Components. They implement the latest state of the Fluent design language, are built on FAST and work in every major browser.</Summary>
    <PackageTags>Fluent UI, Blazor, Web Components, .NET9</PackageTags>
    <Title>Microsoft Fluent UI Web Components for Blazor</Title>
    <Description>A set of Blazor components wrapping Microsoft’s official Fluent UI Web Components. They implement the latest state of the Fluent design language, are built on FAST and work in every major browser.</Description>
    <PackageReadmeFile>README.md</PackageReadmeFile>
    <PackageIcon>icon.png</PackageIcon>

    <SignAssembly>False</SignAssembly>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <LangVersion>latest</LangVersion>

    <GenerateDocumentationFile>true</GenerateDocumentationFile>
    <IsPackable>true</IsPackable>

    <EmbedUntrackedSources>true</EmbedUntrackedSources>
    <DebugType>embedded</DebugType>

    <PackageOutputPath>$(SolutionDir)artifacts</PackageOutputPath>

    <!-- Write the generated files to a specific folder -->
    <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
    <CompilerGeneratedFilesOutputPath>$(SolutionDir).generated</CompilerGeneratedFilesOutputPath>

    <!-- Disable the auto-generated CSS Bundle, to use the Components.Scripts project -->
    <DisableScopedCssBundling>true</DisableScopedCssBundling>
    <ScopedCssEnabled>false</ScopedCssEnabled>
  </PropertyGroup>

  <PropertyGroup>
    <IsTrimmable>true</IsTrimmable>
    <TrimMode>link</TrimMode>
    <EnableTrimAnalyzer>true</EnableTrimAnalyzer>
  </PropertyGroup>

  <!-- Debug -->
  <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
    <Optimize>False</Optimize>
    <WarningLevel>6</WarningLevel>
    <NullableReferenceTypes>true</NullableReferenceTypes>
  </PropertyGroup>

  <!-- Release -->
  <PropertyGroup Condition="'$(Configuration)'=='Release'">
    <Optimize>True</Optimize>
    <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
  </PropertyGroup>

  <ItemGroup>
    <None Include="..\..\README.md" Pack="true" PackagePath="\" />
    <None Include="..\..\icon.png" Pack="true" PackagePath="\" />
    <None Include="**\*.ts" />
  </ItemGroup>

  <ItemGroup>
    <TypeScriptCompile Remove="Components\Nav\FluentNav.razor.ts" />
    <TypeScriptCompile Remove="Components\Nav\FluentNavCategory.razor.ts" />
  </ItemGroup>


  <ItemGroup>
    <SupportedPlatform Include="browser" />
  </ItemGroup>

  <!-- Code Analysis -->
  <ItemGroup>
    <PackageReference Include="Microsoft.VisualStudio.Threading.Analyzers">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Meziantou.Analyzer">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <!-- Dependencies -->
  <ItemGroup>
	  <PackageReference Include="Microsoft.AspNetCore.Components.Web" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Abstractions" />
    <PackageReference Include="Microsoft.Extensions.Hosting.Abstractions" />
    <PackageReference Include="Microsoft.Extensions.Http" />
    <PackageReference Include="Microsoft.TypeScript.MSBuild" Condition="'$(TargetFramework)'=='net9.0'">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.VisualStudioEng.MicroBuild.Core">
	    <PrivateAssets>all</PrivateAssets>
	    <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
	  </PackageReference>
    <ProjectReference Include="..\Core.Scripts\Microsoft.FluentUI.AspNetCore.Components.Scripts.esproj" PrivateAssets="All" />
  </ItemGroup>

  <!-- GitHub -->
  <PropertyGroup Condition="'$(GITHUB_ACTIONS)' == 'true' Or '$(TF_BUILD)' == 'true'">
    <ContinuousIntegrationBuild>true</ContinuousIntegrationBuild>
  </PropertyGroup>

  <!-- Copy XML files to the Demo project (to generate the API documentation) -->
  <Target Name="PostBuild" AfterTargets="PostBuildEvent">
    <ItemGroup>
      <XmlFiles Include="$(ProjectDir)bin\$(Configuration)\net9.0\*.xml" />
    </ItemGroup>
    <Copy SourceFiles="@(XmlFiles)" DestinationFolder="$(SolutionDir)examples\Tools\FluentUI.Demo.DocApiGen" />
  </Target>

  <!-- SDK 9.0.300 Broken with WASM Standalone Razor JS Modules -->
  <Target Name="NormalizeContentPathsForLinux" BeforeTargets="GetTargetPathWithTargetPlatformMoniker">

    <Message Importance="high" Text="Building on Linux!" Condition="$([MSBuild]::IsOSPlatform('Linux'))" />

    <PropertyGroup>
      <ProjectFullPath>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)'))</ProjectFullPath>
    </PropertyGroup>

    <!-- Save Content items with absolute paths for normalization -->
    <ItemGroup>
      <_ContentWithAbsolutePaths Include="@(Content)" Condition="$([System.String]::Copy('%(Identity)').StartsWith('/'))">
        <OriginalIdentity>%(Identity)</OriginalIdentity>
        <NormalizedPath>$([MSBuild]::MakeRelative($(ProjectFullPath), '%(FullPath)'))</NormalizedPath>
      </_ContentWithAbsolutePaths>
    </ItemGroup>

    <!-- Log before modification -->
    <Message Importance="normal" Text="Found @(_ContentWithAbsolutePaths-&gt;Count()) Content items with absolute paths to normalize" />

    <!-- Remove the items with absolute paths -->
    <ItemGroup Condition="$([MSBuild]::IsOSPlatform('Linux'))">
      <Content Remove="@(_ContentWithAbsolutePaths->'%(OriginalIdentity)')" />
    </ItemGroup>

    <!-- Add them back with normalized paths -->
    <ItemGroup Condition="$([MSBuild]::IsOSPlatform('Linux'))">
      <Content Include="@(_ContentWithAbsolutePaths->'%(NormalizedPath)')" />
    </ItemGroup>

    <!-- Log after modification -->
    <Message Importance="normal" Text="Normalized paths for Content items on Linux" Condition="$([MSBuild]::IsOSPlatform('Linux'))" />

  </Target>

  <!-- Resources Localization  -->
  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.ResxSourceGenerator">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>

    <EmbeddedResource Update="Localization\LanguageResource.resx">
      <Public>true</Public>
      <OmitGetResourceString>true</OmitGetResourceString>
      <AsConstants>true</AsConstants>
      <NoWarn>CS1591</NoWarn>
    </EmbeddedResource>
  </ItemGroup>
</Project>
