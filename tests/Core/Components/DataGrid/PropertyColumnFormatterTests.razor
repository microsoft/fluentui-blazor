@using Bunit
@using Xunit

@inherits Bunit.BunitContext

@code
{
	public PropertyColumnFormatterTests()
    {
        JSInterop.Mode = JSRuntimeMode.Loose;
        Services.AddFluentUIComponents();

        var keycodeService = new KeyCodeService();
        Services.AddScoped<IKeyCodeService>(factory => keycodeService);
    }

    private protected class CustomFormattable : IFormattable
    {
        private readonly string _value;
        public CustomFormattable(string value) => _value = value;
        public string ToString(string? format, IFormatProvider? provider) =>
            string.IsNullOrEmpty(format) ? _value : string.Format(provider, format, _value);
    }

    private readonly IList<Person> _people =
    [
        new Person(1, new("Jean Martin"), new DateOnly(1985, 3, 16), string.Empty),
        new Person(2, new("Kenji Sato"), new DateOnly(2004, 1, 9), string.Empty),
        new Person(3, new("Julie Smith"), new DateOnly(1958, 10, 10), string.Empty),
    ];

    private protected IQueryable<Person> People => _people.AsQueryable();


    [Fact]
    public void PropertyGrid_Should_Format_ValueTypes()
    {
        var cut = Render(
            @<FluentDataGrid Items="@People" TGridItem="Person">
                <PropertyColumn Property="@(p => p.PersonId)" Format="D4" />
            </FluentDataGrid>
        );

        var firstCellText = cut.Find("td").TextContent;
        Assert.Equal("0001", firstCellText);
    }

    [Fact]
    public void PropertyGrid_Should_Format_NullableValueTypes()
    {
        var cut = Render(
            @<FluentDataGrid Items="@People" TGridItem="Person">
                <PropertyColumn Property="@(p => p.BirthDate)" Format="m" />
            </FluentDataGrid>
        );

        var firstCellText = cut.Find("td").TextContent;
        Assert.Equal(_people[0].BirthDate!.Value.ToString("m"), firstCellText);
    }

    [Fact]
    public void PropertyGrid_Should_Format_ReferenceTypes()
    {
        var cut = Render(
            @<FluentDataGrid Items="@People" TGridItem="Person">
                <PropertyColumn Property="@(p => p.Name)" Format="{0} test" />
            </FluentDataGrid>
        );

        var firstCellText = cut.Find("td").TextContent;
        Assert.Equal(string.Format("{0} test", _people[0].Name), firstCellText);
    }


    [Fact]
    public void PropertyGrid_Should_Throw_When_FormatUsedOnNonFormattableProperty()
    {
        Assert.Throws<InvalidOperationException>(() => Render(
            @<FluentDataGrid Items="@People" TGridItem="Person">
                <PropertyColumn Property="@(p => p.NickName)" Format="{0} test" />
            </FluentDataGrid>
        ));
    }

	private protected record Person(int PersonId, CustomFormattable Name, DateOnly? BirthDate, string NickName)
    {
        public bool Selected { get; set; }
    };
}
