@using Bunit.TestDoubles
@using Xunit
@using Microsoft.FluentUI.AspNetCore.Components
@inherits Bunit.TestContext

@code {
	public FluentNavItemTests()
	{
		JSInterop.Mode = JSRuntimeMode.Loose;
		Services.AddFluentUIComponents();
	}

	[Fact]
	public void FluentNavItem_Renders_As_Link_When_Href_Provided()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem Href="https://example.com">Test Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("<a ", cut.Markup);
		Assert.Contains("href=\"https://example.com\"", cut.Markup);
		Assert.Contains("Test Item", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Renders_As_Button_When_No_Href_Provided()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem>Test Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("<button", cut.Markup);
		Assert.Contains("Test Item", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_With_OnClick_Handler()
	{
		// Arrange & Act
		bool clicked = false;

		var cut = Render(@<FluentNav>
			<FluentNavItem OnClick="@(() => { clicked = true; })" Id="custom-id">Test Item</FluentNavItem>
			</FluentNav>
		);

		// Assert
		Assert.NotNull(cut);
		var button = cut.Find("#custom-id");
		button.Click();

		Assert.True(clicked);
	}

	[Fact]
	public void FluentNavItem_With_OnClick_Handler_And_Href()
	{
		var cut = Render(@<FluentNav>
			<FluentNavItem OnClick="@(() => { })" Href="https://example.com" Id="custom-id">Test Item</FluentNavItem>
			</FluentNav>
		);

		// Assert
		// Assert
		Assert.NotNull(cut);
		Assert.Contains("<a ", cut.Markup);
		Assert.Contains("href=\"https://example.com\"", cut.Markup);
		Assert.Contains("Test Item", cut.Markup);
	}

	// [Fact]
	// public void FluentNavItem_Renders_With_Active_State()
	// {
	// 	// Arrange & Act
	// 	var cut = Render(@<FluentNav>
	// 		<FluentNavItem Href="https://example.com" Active="true">Active Item</FluentNavItem>
	// 	</FluentNav>);

	// 	// Assert
	// 	Assert.NotNull(cut);
	// 	Assert.Contains("active", cut.Markup);
	// }

	[Fact]
	public void FluentNavItem_Renders_With_Disabled_State()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem Href="https://example.com" Disabled="true">Disabled Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("disabled", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Renders_With_Disabled_State_As_Button()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem Disabled="true">Disabled Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("disabled", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Renders_With_Disabled_State_As_Button_And_Clicked()
	{
		// Arrange & Act
		bool clicked = false;

		var cut = Render(@<FluentNav>
			<FluentNavItem Disabled="true" OnClick="@(() => { clicked = true; })" Id="custom-id">Test Item</FluentNavItem>
			</FluentNav>
		);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("disabled", cut.Markup);

		var button = cut.Find("#custom-id");
		button.Click();
		Assert.False(clicked);
	}

	[Fact]
	public void FluentNavItem_Renders_With_CustomClass()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem Href="https://example.com" Class="custom-nav-item">Test Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("custom-nav-item", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Throws_When_Not_Child_Of_NavDrawer()
	{
		// Arrange & Act & Assert
		var ex = Assert.Throws<InvalidOperationException>(() =>
		{
			Render(@<FluentNavItem Href="https://example.com">Test Item</FluentNavItem>);
		});

		Assert.Contains("must be used as a child of", ex.Message);
		Assert.Contains("FluentNav", ex.Message);
	}

	[Fact]
	public void FluentNavItem_Renders_With_Small_Density()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav Density="NavDrawerDensity.Small">
			<FluentNavItem Href="https://example.com">Test Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);
		Assert.Contains("density=", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Renders_With_Icon()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavItem Icon="@Samples.Icons.Info">Test Item</FluentNavItem>
		</FluentNav>);
		// Assert
		Assert.NotNull(cut);
		Assert.Contains("<svg class=\"icon\" style=\"width: 24px;", cut.Markup);
		Assert.Contains("Test Item", cut.Markup);
	}

	// Renders without icon if FluentNav.UseIsons = false
	[Fact]
	public void FluentNavItem_Renders_Without_Icon_When_Not_UseIcons()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav UseIcons="false">
			<FluentNavItem Icon="@Samples.Icons.Info">Test Item</FluentNavItem>
		</FluentNav>);
		// Assert
		Assert.NotNull(cut);
		Assert.DoesNotContain("<svg class=\"icon\"", cut.Markup);
		Assert.Contains("Test Item", cut.Markup);
	}

	// Write a test for checking the _isActive state of FluentNavItem when the Href matches the current URI
	[Fact]
	public void FluentNavItem_IsActive_When_Href_Matches_Current_URI()
	{
		// Arrange
		var navMan = Services.GetRequiredService<FakeNavigationManager>();
		navMan.NavigateTo("https://localhost/test", true);

		var cut = Render(@<FluentNav>
			<FluentNavItem Id="link" Icon="@Samples.Icons.Info" Href="https://localhost/test">Test Item</FluentNavItem>
		</FluentNav>);

		// Assert
		Assert.NotNull(cut);

		Assert.Contains("active", cut.Markup);
	}

	[Fact]
	public void FluentNavItem_Dispose()
	{
		// Arrange & Act

		var calledTimes = 0;

		var cut = Render(@<FluentNav>
				<FluentNavItem Href="https://example.com">Test Item</FluentNavItem>
			</FluentNav>
		);

		// Assert
		cut.FindComponent<FluentNavItem>().Instance.Dispose();
		DisposeComponents();

		Assert.Equal(0, calledTimes);

	}
}
