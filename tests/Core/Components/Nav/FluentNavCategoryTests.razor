@using Xunit
@using Microsoft.FluentUI.AspNetCore.Components
@inherits FluentUITestContext

@code {
    public FluentNavCategoryTests()
    {
        JSInterop.Mode = JSRuntimeMode.Loose;
        Services.AddFluentUIComponents();
    }

    [Fact]
    public void FluentNavCategory_Renders_With_Title()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category">
                <div>Category Content</div>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        Assert.NotNull(cut);
        Assert.Contains("Test Category", cut.Markup);
        Assert.Contains("fluent-navcategoryitem", cut.Markup);
    }

    [Fact]
    public void FluentNavCategory_Renders_Expanded_By_Default()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <div>Content</div>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        Assert.NotNull(cut);
        Assert.Contains("aria-expanded", cut.Markup);
    }

    [Fact]
    public void FluentNavCategory_Renders_Collapsed_When_Not_Expanded()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <div>Content</div>
            </FluentNavCategory>
        </FluentNav>
	);

		// Assert
		Assert.NotNull(cut);
		Assert.DoesNotContain("aria-expanded=\"true\"", cut.Markup);
	}

	[Fact]
	public async Task FluentNavCategory_Call_ToggleExpanded()
	{
		// Arrange & Act
		var cut = Render(@<FluentNav>
			<FluentNavCategory Title="Test Category" Expanded="false">
				<div>Content</div>
			</FluentNavCategory>
		</FluentNav>);

		// Act
		var category = cut.FindComponent<FluentNavCategory>();
		await category.Instance.ToggleExpandedAsync();

		// Assert
		Assert.NotNull(cut);
		Assert.True(category.Instance.Expanded);

		await category.Instance.ToggleExpandedAsync();
		Assert.False(category.Instance.Expanded);

	}

    [Fact]
    public void FluentNavCategory_Throws_When_Owner_Is_Derived_Type()
    {
        // Arrange - Create a derived FluentNav (which should fail the exact type check)
        var derivedNav = new DerivedFluentNav(Services.GetRequiredService<LibraryConfiguration>());

        // Act & Assert
        var ex = Assert.Throws<InvalidOperationException>(() =>
        {
            Render(@<CascadingValue Value="@derivedNav">
                <FluentNavCategory Title="Test Category">
                    <div>Content</div>
                </FluentNavCategory>
            </CascadingValue>);
        });

        Assert.Contains("can only be used as a direct child of", ex.Message);
        Assert.Contains("FluentNav", ex.Message);
    }

    [Fact]
    public void FluentNavCategory_Renders_With_CustomId()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav>
            <FluentNavCategory Id="my-category-id" Title="Test Category">
                <div>Content</div>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        Assert.NotNull(cut);
        Assert.Contains("id=\"my-category-id\"", cut.Markup);
    }

    [Fact]
    public void FluentNavCategory_Renders_With_Small_Density()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav Density="NavDrawerDensity.Small">
            <FluentNavCategory Title="Test Category">
                <div>Content</div>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        Assert.NotNull(cut);
        Assert.Contains("density=", cut.Markup);
    }

    [Fact]
    public void FluentNavCategory_Provides_CascadingValue_To_SubItems()
    {
        // Arrange & Act
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category">
                <FluentNavItem>Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        Assert.NotNull(cut);
        Assert.Contains("Sub Item", cut.Markup);
        Assert.Contains("fluent-navsubitem", cut.Markup);
    }

	[Fact]
	public void FluentNavCategory_Dispose()
	{
		// Arrange & Act

		var calledTimes = 0;

		var cut = Render(@<FluentNav>
				<FluentNavCategory Title="Test Category">
					<FluentNavItem>Sub Item</FluentNavItem>
				</FluentNavCategory>
			</FluentNav>
		);

		// Assert
		cut.FindComponent<FluentNavCategory>().Instance.Dispose();
		cut.Dispose();

		Assert.Equal(0, calledTimes);

	}

    [Fact]
    public void FluentNavCategory_Auto_Expands_When_SubItem_Is_Active_On_Initial_Load()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        var testUri = navManager.ToAbsoluteUri("/test-page").ToString();

        // Navigate to a test URI that will match the subitem
        navManager.NavigateTo("/test-page");

        // Act - Render with a subitem that matches the current location
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test-page">Active Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        var category = cut.FindComponent<FluentNavCategory>();
        Assert.True(category.Instance.Expanded, "Category should auto-expand when subitem is active on initial load");
        Assert.True(category.Instance.HasActiveSubitem(), "Should have an active subitem");
        Assert.Contains("aria-expanded=\"true\"", cut.Markup);
    }

    [Fact]
    public void FluentNavCategory_Does_Not_Auto_Expand_When_No_SubItem_Is_Active()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/other-page");

        // Act - Render with a subitem that does NOT match the current location
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test-page">Inactive Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        // Assert
        var category = cut.FindComponent<FluentNavCategory>();
        Assert.False(category.Instance.Expanded, "Category should remain collapsed when no subitem is active");
        Assert.False(category.Instance.HasActiveSubitem(), "Should not have an active subitem");
    }

    [Fact]
    public async Task FluentNavCategory_SetExpandedAsync_Expands_Category()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.False(category.Instance.Expanded, "Category should start collapsed");

        // Act
        await category.Instance.SetExpandedAsync(true);

        // Assert
        Assert.True(category.Instance.Expanded, "Category should be expanded");
        Assert.Contains("aria-expanded=\"true\"", cut.Markup);
    }

    [Fact]
    public async Task FluentNavCategory_SetExpandedAsync_Collapses_Category()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.True(category.Instance.Expanded, "Category should start expanded");

        // Act
        await category.Instance.SetExpandedAsync(false);

        // Assert
        Assert.False(category.Instance.Expanded, "Category should be collapsed");
        Assert.DoesNotContain("aria-expanded=\"true\"", cut.Markup);
    }

    [Fact]
    public async Task FluentNavCategory_SetExpandedAsync_Does_Nothing_When_State_Unchanged()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        var initialExpanded = category.Instance.Expanded;

        // Act - Try to expand when already expanded
        await category.Instance.SetExpandedAsync(true);

        // Assert - State should remain unchanged
        Assert.Equal(initialExpanded, category.Instance.Expanded);
        Assert.True(category.Instance.Expanded, "Category should remain expanded");
    }

    [Fact]
    public async Task FluentNavCategory_SetExpandedAsync_Clears_Manual_Collapse_Flag()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/test-page");

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test-page">Active Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // Manually collapse the category (sets _hasBeenManuallyCollapsed flag)
        await category.Instance.ToggleExpandedAsync();
        Assert.False(category.Instance.Expanded, "Category should be manually collapsed");

        // Act - Programmatically collapse via SetExpandedAsync (should clear the flag)
        await category.Instance.SetExpandedAsync(false);

        // Navigate to trigger location change - should NOT auto-expand since we used SetExpandedAsync
        navManager.NavigateTo("/other-page");
        navManager.NavigateTo("/test-page");

        // Wait for the location change to process
        cut.WaitForState(() => category.Instance.HasActiveSubitem(), timeout: TimeSpan.FromSeconds(2));

        // Assert - Category should auto-expand because SetExpandedAsync cleared the manual collapse flag
        await Task.Delay(100, CancellationToken.None); // Give time for OnSubitemActiveStateChanged to execute

		// The category should auto-expand because programmatic collapse cleared the flag
        Assert.True(category.Instance.Expanded, "Category should auto-expand after SetExpandedAsync cleared the manual collapse flag");
    }

    [Fact]
    public async Task FluentNavCategory_SetExpandedAsync_Triggers_StateHasChanged()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        var markupBefore = cut.Markup;

        // Act
        await category.Instance.SetExpandedAsync(true);

        // Assert - Markup should have changed, indicating StateHasChanged was called
        var markupAfter = cut.Markup;
        Assert.NotEqual(markupBefore, markupAfter);
        Assert.Contains("aria-expanded=\"true\"", markupAfter);
        Assert.DoesNotContain("aria-expanded=\"true\"", markupBefore);
	}

    [Fact]
    public async Task FluentNavCategory_ExpandedChanged_Fires_When_State_Changes()
    {
        // Arrange
        var expandedChangedCallCount = 0;
        var lastExpandedValue = false;

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" 
                               Expanded="false"
                               ExpandedChanged="@((bool expanded) => { expandedChangedCallCount++; lastExpandedValue = expanded; })">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.Equal(0, expandedChangedCallCount);

        // Act - Expand the category
        await category.Instance.SetExpandedAsync(true);

        // Assert
        Assert.Equal(1, expandedChangedCallCount);
        Assert.True(lastExpandedValue, "ExpandedChanged should receive true");

        // Act - Collapse the category
        await category.Instance.SetExpandedAsync(false);

        // Assert
        Assert.Equal(2, expandedChangedCallCount);
        Assert.False(lastExpandedValue, "ExpandedChanged should receive false");
    }

    [Fact]
    public async Task FluentNavCategory_ExpandedChanged_Does_Not_Fire_When_State_Unchanged()
    {
        // Arrange
        var expandedChangedCallCount = 0;

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" 
                               Expanded="true"
                               ExpandedChanged="@((bool expanded) => { expandedChangedCallCount++; })">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.Equal(0, expandedChangedCallCount);

        // Act - Try to expand when already expanded
        await category.Instance.SetExpandedAsync(true);

        // Assert - ExpandedChanged should not fire because state didn't change
        Assert.Equal(0, expandedChangedCallCount);
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Fires_ExpandedChanged()
    {
        // Arrange
        var expandedChangedCallCount = 0;
        var lastExpandedValue = false;

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" 
                               Expanded="false"
                               ExpandedChanged="@((bool expanded) => { expandedChangedCallCount++; lastExpandedValue = expanded; })">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // Act - Toggle to expand
        await category.Instance.ToggleExpandedAsync();

        // Assert
        Assert.Equal(1, expandedChangedCallCount);
        Assert.True(lastExpandedValue, "ExpandedChanged should receive true");

        // Act - Toggle to collapse
        await category.Instance.ToggleExpandedAsync();

        // Assert
        Assert.Equal(2, expandedChangedCallCount);
        Assert.False(lastExpandedValue, "ExpandedChanged should receive false");
    }

    [Fact]
    public void FluentNavCategory_RegisterSubitem_Adds_SubItem_To_Collection()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // Assert
        Assert.True(category.Instance.HasActiveSubitem() || !category.Instance.HasActiveSubitem(),
            "Should be able to check for active subitems");
    }

    [Fact]
    public void FluentNavCategory_UnregisterSubitem_Removes_SubItem_From_Collection()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/test1");

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        var subitem = cut.FindComponent<FluentNavItem>();

        // Verify subitem is registered and active
        Assert.True(category.Instance.HasActiveSubitem(), "Subitem should be active initially");

        // Act - Dispose the subitem (which calls UnregisterSubitem)
        subitem.Instance.Dispose();

        // Assert
        Assert.False(category.Instance.HasActiveSubitem(),
            "Should have no active subitems after unregistering");
    }

    [Fact]
    public void FluentNavCategory_UnregisterSubitem_Does_Not_Throw_When_SubItem_Not_Found()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // Create a separate subitem instance (not registered)
        var unregisteredSubitem = new FluentNavItem(Services.GetRequiredService<LibraryConfiguration>())
        {
            Owner = null!,
            NavigationManager = Services.GetRequiredService<NavigationManager>(),
            Category = null!
        };

        // Act & Assert - Should not throw
        category.Instance.UnregisterSubitem(unregisteredSubitem);
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Expands_When_Collapsed()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.False(category.Instance.Expanded, "Should start collapsed");

        // Act
        await category.Instance.ToggleExpandedAsync();

        // Assert
        Assert.True(category.Instance.Expanded, "Should be expanded after toggle");
        Assert.Contains("aria-expanded=\"true\"", cut.Markup);
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Collapses_When_Expanded()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.True(category.Instance.Expanded, "Should start expanded");

        // Act
        await category.Instance.ToggleExpandedAsync();

        // Assert
        Assert.False(category.Instance.Expanded, "Should be collapsed after toggle");
        Assert.DoesNotContain("aria-expanded=\"true\"", cut.Markup);
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Sets_Manual_Collapse_Flag_When_Collapsing_With_Active_SubItem()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/test-page");

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test-page">Active Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        Assert.True(category.Instance.HasActiveSubitem(), "Should have active subitem");

        // Act - Manually collapse the category
        await category.Instance.ToggleExpandedAsync();
        Assert.False(category.Instance.Expanded, "Should be collapsed");
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Clears_Manual_Collapse_Flag_When_Expanding()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/test-page");

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test-page">Active Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // Manually collapse (sets the flag)
        await category.Instance.ToggleExpandedAsync();
        Assert.False(category.Instance.Expanded);

        // Act - Manually expand again (should clear the flag)
        await category.Instance.ToggleExpandedAsync();
        Assert.True(category.Instance.Expanded);

        // Now collapse programmatically
        await category.Instance.SetExpandedAsync(false);

        // Navigate to trigger auto-expansion
        navManager.NavigateTo("/other-page");
        navManager.NavigateTo("/test-page");

        cut.WaitForState(() => category.Instance.HasActiveSubitem(), timeout: TimeSpan.FromSeconds(2));
        await Task.Delay(100, CancellationToken.None);

        // Assert - Should auto-expand because manual toggle cleared the flag
        Assert.True(category.Instance.Expanded,
        "Should auto-expand because manual expand cleared the collapse flag");
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_With_UseSingleExpanded_Collapses_Other_Categories()
    {
        // Arrange
        var cut = Render(@<FluentNav UseSingleExpanded="true">
            <FluentNavCategory Title="Category 1" Expanded="true">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
            <FluentNavCategory Title="Category 2" Expanded="false">
                <FluentNavItem Href="/test2">Sub Item 2</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var categories = cut.FindComponents<FluentNavCategory>();
        var category1 = categories[0];
        var category2 = categories[1];

        Assert.True(category1.Instance.Expanded, "Category 1 should start expanded");
        Assert.False(category2.Instance.Expanded, "Category 2 should start collapsed");

        // Act - Toggle category 2 (should collapse category 1)
        await category2.Instance.ToggleExpandedAsync();

        // Assert
        Assert.False(category1.Instance.Expanded, "Category 1 should be collapsed");
        Assert.True(category2.Instance.Expanded, "Category 2 should be expanded");
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_With_UseSingleExpanded_False_Does_Not_Collapse_Others()
    {
        // Arrange
        var cut = Render(@<FluentNav UseSingleExpanded="false">
            <FluentNavCategory Title="Category 1" Expanded="true">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
            <FluentNavCategory Title="Category 2" Expanded="false">
                <FluentNavItem Href="/test2">Sub Item 2</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var categories = cut.FindComponents<FluentNavCategory>();
        var category1 = categories[0];
        var category2 = categories[1];

        Assert.True(category1.Instance.Expanded, "Category 1 should start expanded");
        Assert.False(category2.Instance.Expanded, "Category 2 should start collapsed");

        // Act - Toggle category 2 (should NOT collapse category 1)
        await category2.Instance.ToggleExpandedAsync();

        // Assert
        Assert.True(category1.Instance.Expanded, "Category 1 should remain expanded");
        Assert.True(category2.Instance.Expanded, "Category 2 should be expanded");
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Does_Not_Collapse_Self_In_Single_Expand_Mode()
    {
        // Arrange
        var cut = Render(@<FluentNav UseSingleExpanded="true">
            <FluentNavCategory Title="Category 1" Expanded="false">
                <FluentNavItem Href="/test1">Sub Item 1</FluentNavItem>
            </FluentNavCategory>
            <FluentNavCategory Title="Category 2" Expanded="true">
                <FluentNavItem Href="/test2">Sub Item 2</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var categories = cut.FindComponents<FluentNavCategory>();
        var category1 = categories[0];
        var category2 = categories[1];

        // Act - Toggle category 1 to expand (should collapse category 2 but not itself)
        await category1.Instance.ToggleExpandedAsync();

        // Assert
        Assert.True(category1.Instance.Expanded, "Category 1 should be expanded");
        Assert.False(category2.Instance.Expanded, "Category 2 should be collapsed");
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Updates_Active_State()
    {
        // Arrange
        var navManager = Services.GetRequiredService<NavigationManager>();
        navManager.NavigateTo("/test-page");

        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="true">
                <FluentNavItem Href="/test-page">Active Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();

        // When expanded with active subitem, should not show active class
        Assert.DoesNotContain("class=\"fluent-navcategoryitem active\"", cut.Markup);

        // Act - Collapse the category
        await category.Instance.ToggleExpandedAsync();

        // Assert - When collapsed with active subitem, should show active class
        cut.WaitForAssertion(() =>
        {
            Assert.Contains("fluent-navcategoryitem active", cut.Markup);
        }, TimeSpan.FromSeconds(1));
    }

    [Fact]
    public async Task FluentNavCategory_ToggleExpandedAsync_Triggers_Animation()
    {
        // Arrange
        var cut = Render(@<FluentNav>
            <FluentNavCategory Title="Test Category" Expanded="false">
                <FluentNavItem Href="/test">Sub Item</FluentNavItem>
            </FluentNavCategory>
        </FluentNav>);

        var category = cut.FindComponent<FluentNavCategory>();
        var jsInvocations = JSInterop.Invocations.ToList();
        var initialCount = jsInvocations.Count;

        // Act - Toggle to expand
        await category.Instance.ToggleExpandedAsync();

        // Assert - Should have called JS animation (if module is imported)
        // Note: In loose mode, JS calls may not be tracked, so we verify state change
        Assert.True(category.Instance.Expanded, "Category should be expanded");

        // Toggle back to collapse
        await category.Instance.ToggleExpandedAsync();
        Assert.False(category.Instance.Expanded, "Category should be collapsed");
    }
}
