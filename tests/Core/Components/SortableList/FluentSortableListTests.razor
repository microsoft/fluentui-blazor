@using System.Globalization
@using Xunit;
@inherits FluentUITestContext
@code
{
	public class Item
	{
		public int Id { get; set; }
		public string Name { get; set; } = "";
		public bool Disabled { get; set; } = false;
	}

	public List<Item> items = Enumerable.Range(1, 10).Select(i => new Item { Id = i, Name = $"Item {i}" }).ToList();

	public FluentSortableListTests()
	{
		JSInterop.Mode = JSRuntimeMode.Loose;
		Services.AddFluentUIComponents();
	}

	[Fact]
	public void FluentSortableList_Default()
	{
		// Arrange && Act

		var cut = Render(@<FluentSortableList Items="items">
			<ItemTemplate>
				<div class="sortable-item">@context.Name</div>
			</ItemTemplate>
		</FluentSortableList>);

		// Assert
		cut.Verify();
	}

	[Fact]
	public void FluentSortableList_IdIsAdded()
	{
		// Arrange && Act

		var cut = Render(@<FluentSortableList Id="list" Items="items">
			<ItemTemplate>
				<div class="sortable-item">@context.Name</div>
			</ItemTemplate>
		</FluentSortableList>);

		// Assert
		cut.Verify();
	}

	[Fact]
	public async Task FluentSortableList_OnUpdate()
	{
		// Arrange
		FluentSortableListEventArgs? args = null;
		FluentSortableList<Item>? sortableList = null;

		var callback = new EventCallbackFactory().Create<AspNetCore.Components.FluentSortableListEventArgs>
			(this, (e => args = e));

		var cut = Render(@<FluentSortableList @ref="sortableList" Id="list" Items="items" OnUpdate="callback">
			<ItemTemplate>
				<div class="sortable-item">@context.Name</div>
			</ItemTemplate>
		</FluentSortableList>);

		// Act
		await sortableList!.OnUpdateJSAsync(0, 1, "fromList", "toList");

		// Verify
		Assert.Equal(new FluentSortableListEventArgs(0, 1, "fromList", "toList"), args,
			FluentSortableListEventArgsComparer);
	}

	[Fact]
	public async Task FluentSortableList_OnRemove()
	{
		// Arrange
		FluentSortableListEventArgs? args = null;
		FluentSortableList<Item>? sortableList = null;

		var callback = new EventCallbackFactory().Create<AspNetCore.Components.FluentSortableListEventArgs>
			(this, (e => args = e));

		var cut = Render(@<FluentSortableList @ref="sortableList" Id="list" Items="items" OnRemove="callback">
			<ItemTemplate>
				<div class="sortable-item">@context.Name</div>
			</ItemTemplate>
		</FluentSortableList>);

		// Act
		await sortableList!.OnRemoveJSAsync(0, 1, "fromList", "toList", "true");

		// Verify
		Assert.Equal(new FluentSortableListEventArgs(0, 1, "fromList", "toList"), args,
			FluentSortableListEventArgsComparer);
	}

	[Fact]
	public void FluentSortableList_ItemFilter()
	{
		// Arrange
		items[0].Disabled = true;

		// Act
		var cut = Render(@<FluentSortableList Items="items" ItemFilter="@(i => i.Disabled)">
			<ItemTemplate>
				<div class="sortable-item">@context.Name</div>
			</ItemTemplate>
		</FluentSortableList>);

		// Assert
		cut.Verify();
	}

    [Fact]
    public async Task FluentSortableList_DisposeTwice()
    {
        // Arrange
        FluentSortableList<Item>? sortableList = null;
        Render(@<FluentSortableList @ref="sortableList" Items="items">
            <ItemTemplate>
                <div class="sortable-item">@context.Name</div>
            </ItemTemplate>
        </FluentSortableList>);

        // Act
        await sortableList!.DisposeAsync();

        // Assert
        var exception = await Record.ExceptionAsync(async () => await sortableList!.DisposeAsync());
        Assert.Null(exception);
    }

    private static bool FluentSortableListEventArgsComparer(FluentSortableListEventArgs? first, FluentSortableListEventArgs? second)
    {
        if (first is null || second is null)
        {
            return false;
        }

        if (first.FromListId is null || !first.FromListId.Equals(second.FromListId))
        {
            return false;
        }

        if (first.ToListId is null || !first.ToListId.Equals(second.ToListId))
        {
            return false;
        }

        if (first.OldIndex != second.OldIndex)
        {
            return false;
        }

        if (first.NewIndex != second.NewIndex)
        {
            return false;
        }

        return true;
    }

}
