@using Xunit;
@using Bunit.Rendering
@using Microsoft.FluentUI.AspNetCore.Components.Tests.Verify
@inherits FluentUITestContext

@code
{
    public FluentMultiSplitterTests()
    {
        JSInterop.Mode = JSRuntimeMode.Loose;
        Services.AddFluentUIComponents();
    }

    [Fact]
    public void FluentMultiSplitter_Horizontal_Basic()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.Add(p => p.Orientation, Orientation.Horizontal);
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_Vertical_Basic()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.Add(p => p.Orientation, Orientation.Vertical);
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_PaneCollapsible()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Collapsible, true);
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Collapsible, true);
                pane.AddChildContent("Pane B");
            });
        });

        // Assert
        cut.Verify();
    }

    [Fact]
    public async Task FluentMultiSplitter_PaneResizedRaised()
    {
        bool eventCalled = false;
        double newSize = 0;

        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.Add(p => p.OnResize, (e) => { eventCalled = true; newSize = e.NewSize; });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // MouseUp
        await cut.InvokeAsync(async () => await cut.Instance.OnPaneResizedAsync(0, 20, 1, 80));

        // Assert
        Assert.True(eventCalled);
        Assert.Equal(80, newSize);
        cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_PaneResizedReceived()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Min, "50px");
                pane.Add(p => p.Max, "70%");
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.MouseDown();

        // Assert
        cut.Verify();
    }

    [Fact]
    public async Task FluentMultiSplitter_PaneResizeCanceled()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.Add(p => p.OnResize, (e) => e.Cancel = true);
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Size, "40%");
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Size, "60%");
                pane.AddChildContent("Pane B");
            });
        });

        // MouseUp
        await cut.InvokeAsync(async () => await cut.Instance.OnPaneResizedAsync(0, 20, 1, 80));

        // New values (20% and 80%) are rollbacked to initial values (40% and 60%)
        Assert.Contains("flex-basis: 40%;", cut.Markup);
        Assert.Contains("flex-basis: 60%;", cut.Markup);

        // Assert
        cut.Verify();
    }

    [Fact]
    public async Task FluentMultiSplitter_Size_Fixed()
    {
        // Arrange
        var cut = Render(
            @<FluentMultiSplitter>
                <FluentMultiSplitterPane>Pane A</FluentMultiSplitterPane>
                <FluentMultiSplitterPane Resizable="false" Size="300px">Pane B</FluentMultiSplitterPane>
            </FluentMultiSplitter>
    );

        await cut.FindComponent<FluentMultiSplitter>().Instance.RefreshAsync();

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_Expand()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "expand");

        // Assert
        Assert.True(result.EventCalled);
        result.Cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_Expand_Canceled()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "expand", secondClickOn: null, firstCancel: true);

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[0], result.Cut.Markup);
    }

    [Fact]
    public void FluentMultiSplitter_CollapseAndExpand()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "collapse", secondClickOn: "expand");

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[0].ScrubBlazorAttributes(), result.Cut.Markup.ScrubBlazorAttributes());
    }

    [Fact]
    public void FluentMultiSplitter_CollapseAndExpand_ButCanceled()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "collapse", secondClickOn: "expand", secondCancel: true);

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[1].ScrubBlazorAttributes(), result.Cut.Markup.ScrubBlazorAttributes());
    }

    [Fact]
    public void FluentMultiSplitter_Collapse()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "collapse");

        // Assert
        Assert.True(result.EventCalled);
        result.Cut.Verify();
    }

    [Fact]
    public void FluentMultiSplitter_Collapse_Canceled()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "collapse", secondClickOn: null, firstCancel: true);

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[0], result.Cut.Markup);
    }

    [Fact]
    public void FluentMultiSplitter_ExpandAndCollapse()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "expand", secondClickOn: "collapse");

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[0].ScrubBlazorAttributes(), result.Cut.Markup.ScrubBlazorAttributes());
    }

    [Fact]
    public void FluentMultiSplitter_ExpandAndCollapse_ButCanceled()
    {
        // Act
        var result = RenderExpandCollapse(firstClickOn: "expand", secondClickOn: "collapse", secondCancel: true);

        // Assert
        Assert.True(result.EventCalled);
        Assert.Equal(result.Markups[1].ScrubBlazorAttributes(), result.Cut.Markup.ScrubBlazorAttributes());
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Mousedown()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.MouseDown(new MouseEventArgs { ClientX = 100, ClientY = 200 });

        // Assert
        JSInterop.VerifyInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Touchstart()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.TouchStart(new TouchEventArgs
        {
            Touches = new[] { new TouchPoint { ClientX = 100, ClientY = 200 } }
        });

        // Assert
        JSInterop.VerifyInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Touchstart_Empty()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.TouchStart(new TouchEventArgs { Touches = Array.Empty<TouchPoint>() });

        // Assert
        JSInterop.VerifyNotInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Mousedown_NotResizable()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Resizable, false);
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.MouseDown(new MouseEventArgs { ClientX = 100, ClientY = 200 });

        // Assert
        JSInterop.VerifyNotInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Mousedown_SkipCollapsed()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.Add(p => p.Collapsed, true);
                pane.AddChildContent("Pane B");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane C");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar"); // First bar (between A and B)
        bar.MouseDown(new MouseEventArgs { ClientX = 100, ClientY = 200 });

        // Assert
        // The next resizable should be Pane C because Pane B is collapsed
        var invocation = JSInterop.VerifyInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
        var paneCId = cut.FindComponents<FluentMultiSplitterPane>()[2].Instance.Id;

        Assert.Equal(paneCId, invocation.Arguments[3]);
    }

    [Fact]
    public void FluentMultiSplitter_Resize_Mousedown_Vertical()
    {
        // Arrange
        var cut = Render<FluentMultiSplitter>(parameters =>
        {
            parameters.Add(p => p.Orientation, Orientation.Vertical);
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane A");
            });
            parameters.AddChildContent<FluentMultiSplitterPane>(pane =>
            {
                pane.AddChildContent("Pane B");
            });
        });

        // Action
        var bar = cut.Find($".fluent-multi-splitter-bar");
        bar.MouseDown(new MouseEventArgs { ClientX = 100, ClientY = 200 });

        // Assert
        var invocation = JSInterop.VerifyInvoke("Microsoft.FluentUI.Blazor.Components.MultiSplitter.StartResize");
        Assert.Equal("vertical", invocation.Arguments[4]);
        Assert.Equal(200.0, invocation.Arguments[5]); // ClientY used for Vertical
    }

    private (bool EventCalled, string[] Markups, IRenderedComponent<ContainerFragment> Cut) RenderExpandCollapse(string firstClickOn, string? secondClickOn = null, bool firstCancel = false, bool secondCancel = false)
    {
        var eventCalled = 0;
        var markups = new List<string>();

        // Arrange
        var cut = Render(
            @<FluentMultiSplitter OnExpand="@OnExpandCollapse"
                                  OnCollapse="@OnExpandCollapse">
                <FluentMultiSplitterPane Collapsible="true">Pane A</FluentMultiSplitterPane>
                <FluentMultiSplitterPane Collapsible="true">Pane B</FluentMultiSplitterPane>
            </FluentMultiSplitter>
    );

        markups.Add(cut.Markup);

        // First click
        var button1 = cut.Find($"span[part='{firstClickOn}']");
        button1.MouseDown();

        markups.Add(cut.Markup);

        // Second click
        if (secondClickOn != null)
        {
            var button2 = cut.Find($"span[part='{secondClickOn}']");
            button2.MouseDown();
            markups.Add(cut.Markup);
        }

        return (eventCalled > 0, markups.ToArray(), cut);

        void OnExpandCollapse(FluentMultiSplitterEventArgs e)
        {
            eventCalled++;

            if (eventCalled == 1 && firstCancel)
            {
                e.Cancel = true;
            }
            else if (eventCalled == 2 && secondCancel)
            {
                e.Cancel = true;
            }

            Assert.NotEqual(-1, e.PaneIndex);
            Assert.NotNull(e.Pane);
        }
    }
}
