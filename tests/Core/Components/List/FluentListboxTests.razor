@using Microsoft.FluentUI.AspNetCore.Components.Utilities
@using Xunit;
@using Microsoft.FluentUI.AspNetCore.Components.Tests.Samples;
@inherits FluentUITestContext
@code
{
    private readonly IEnumerable<string?> Digits = new[] { null, "One", "Two", "Three" };

    private enum MyDigitsEnum
    {
        One,
        Two,
        Three
    }

    public FluentListboxTests()
    {
        JSInterop.Mode = JSRuntimeMode.Loose;
        Services.AddFluentUIComponents();
    }

    [Fact]
    public void FluentListbox_Default()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" TOption="string" TValue="string" />);

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentListbox_Label()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Label="List of digits" Required="true" Items="@Digits" TOption="string" TValue="string" />);

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentListbox_Manual()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox TOption="string" TValue="string">
            <FluentOptionString Value="One">One</FluentOptionString>
            <FluentOptionString Value="Two">Two</FluentOptionString>
            <FluentOptionString Value="Three">Three</FluentOptionString>
        </FluentListbox>);

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentListbox_Template()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" TOption="string" TValue="string">
            <OptionTemplate>
                @if (!String.IsNullOrEmpty(context))
                {
                    <span>[</span>
                    @context
                    <span>]</span>
                }
            </OptionTemplate>
        </FluentListbox>);

        // Assert
        var two = cut.Find("fluent-option[value='Two']");
        Assert.Equal("[Two]", two.GetInnerText());
    }

    [Fact]
    public void FluentListbox_Enum()
    {
        MyDigitsEnum selectedColor = MyDigitsEnum.One;

        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@GetEnumValues()" @bind-Value="@selectedColor" />);

        // Assert
        cut.Verify();

        // Local function
        IEnumerable<MyDigitsEnum> GetEnumValues() => Enum.GetValues(typeof(MyDigitsEnum)).Cast<MyDigitsEnum>();
    }

    [Fact]
    public void FluentListbox_OptionFunctions()
    {
        // Arrange && Act
        //  - Disable the "Two" option
        //  - Uppercase the text
        //  - Add a prefix to the value
        //  - Select the "One" option
        var cut = Render(@<FluentListbox Items="@Digits"
                      OptionDisabled="@(item => item == "Two")"
                      OptionText="@(item => item?.ToUpper())"
                      OptionValue="@(item => $"value-{item}")" />);

        // Assert
        cut.Verify();
    }

    [Fact]
    public void FluentListbox_Default_InitialSelection()
    {
        string? value = "Two";

        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" Value="@value" />);
        var two = cut.Find("fluent-option[value='Two']");

        // Assert
        Assert.True(two.HasAttribute("selected"));
    }

    [Fact]
    public void FluentListbox_Binding_InitialSelection()
    {
        string? value = "Two";

        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" @bind-Value="@value" />);
        var two = cut.Find("fluent-option[value='Two']");

        // Assert
        Assert.True(two.HasAttribute("selected"));
    }

    [Fact]
    public void FluentListbox_Binding_Updated()
    {
        string? value = "Two";

        // Arrange
        var cut = Render(@<FluentListbox Items="@Digits" @bind-Value="@value" />);

        // Act and re-render
        cut.FindComponent<FluentListbox<string, string>>().Render(parameters => parameters.Add(p => p.Value, "One"));
        var one = cut.Find("fluent-option[value='One']");

        // Assert
        Assert.True(one.HasAttribute("selected"));
    }

    [Fact]
    public async Task FluentListbox_Multiple()
    {
        string value = "One";
        IEnumerable<string> selectedItems = ["One",];

        // Arrange
        var cut = Render(@<FluentListbox Multiple="true" Items="@Digits" @bind-Value="@value" @bind-SelectedItems="@selectedItems" />);
        var ids = cut.FindAll("fluent-option")
                     .Where(i => i.GetAttribute("value") == "One" || i.GetAttribute("value") == "Two")
                     .Select(i => i.GetAttribute("id"));

        // Act
        await cut.FindComponent<FluentListbox<string?, string>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            SelectedOptions = string.Join(';', ids),
        });

        // Assert
        Assert.Equal("One", value);
        Assert.Equal(new[] { "One", "Two" }, selectedItems);
    }

    [Theory]
    [InlineData("")]
    [InlineData(null)]
    [InlineData("InvalidId1;InvalidId2")]
    [InlineData("InvalidId1;    InvalidId2")]
    [InlineData("InvalidId1")]
    public async Task FluentListbox_Multiple_Unselect(string? selectedOptions)
    {
        string? value = "One";
        IEnumerable<string>? selectedItems = ["One",];

        // Arrange
        var cut = Render(@<FluentListbox Id="MyList" Multiple="true" Items="@Digits" @bind-Value="@value" @bind-SelectedItems="@selectedItems" />);

        // Act
        await cut.FindComponent<FluentListbox<string?, string?>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            Id = "MyList",
            Type = "",
            SelectedOptions = selectedOptions,
        });

        // Assert
        Assert.Null(value);
        Assert.Empty(selectedItems);
    }

    [Fact]
    public async Task FluentListbox_Multiple_OptionSelectedComparer()
    {
        string? value = "One";
        IEnumerable<string>? selectedItems = ["One",];

        // Arrange
        var cut = Render(@<FluentListbox
            Id="MyList"
            Multiple="true"
            Items="@Digits"
            OptionSelectedComparer="@((i, j) => string.Compare(i, j, StringComparison.InvariantCultureIgnoreCase) == 0)"
            @bind-Value="@value"
            @bind-SelectedItems="@selectedItems" />);

        // Act
        await cut.FindComponent<FluentListbox<string?, string?>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            Id = "MyList",
            Type = "",
            SelectedOptions = "ONE",    // Upper case to validate the "Ignore case"
        });

        // Assert
        Assert.Null(value);
        Assert.Empty(selectedItems);
    }

    [Fact]
    public void FluentListbox_Data()
    {
        // Arrange
        var myData = "MyData";
        var cut = Render(@<FluentListbox Items="@Digits" Data="@myData" TOption="string" TValue="string" />);

        // Assert
        var component = cut.FindComponent<FluentListbox<string, string>>();
        Assert.Equal("MyData", component.Instance.Data);
    }

    [Fact]
    public async Task FluentListbox_Option_Clicked()
    {
        string? value = "One";

        // Arrange
        var cut = Render(@<FluentListbox Items="@Digits" @bind-Value="@value" />);
        var ids = cut.FindAll("fluent-option")
                     .Where(i => i.GetAttribute("value") == "Two")
                     .Select(i => i.GetAttribute("id"));

        // Act
        await cut.FindComponent<FluentListbox<string?, string?>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            SelectedOptions = string.Join(';', ids),
        });

        // Assert
        Assert.Equal("Two", value);
    }

    [Theory]
    [InlineData(ListAppearance.Outline, null)]
    [InlineData(ListAppearance.FilledLighter, "filled-lighter")]
    [InlineData(ListAppearance.FilledDarker, "filled-darker")]
    [InlineData(ListAppearance.Transparent, "transparent")]
    [InlineData((ListAppearance)999, null)]
    [InlineData(null, null)]
    public void FluentListbox_Appearance(ListAppearance? appearance, string? expected)
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Appearance="@appearance" Items="@Digits" TOption="string" TValue="string" />);
        var attribute = cut.Find("div.fluent-listbox").GetAttribute("appearance");

        // Assert
        Assert.Equal(expected, attribute);
    }

    [Fact]
    public async Task FluentListbox_Manual_OnDropdownChange()
    {
        string? selectedValue = null;
        var valueChangedCalled = false;

        // Arrange - Using manual FluentOptionString elements (no Items collection)
        var cut = Render(@<FluentListbox TOption="string" TValue="string" ValueChanged="@(v => { selectedValue = v; valueChangedCalled = true; })">
            <FluentOptionString Value="One">One</FluentOptionString>
            <FluentOptionString Value="Two">Two</FluentOptionString>
            <FluentOptionString Value="Three">Three</FluentOptionString>
        </FluentListbox>);

        // Get the ID of the "Two" option to simulate selection
        var twoOption = cut.Find("fluent-option[value='Two']");
        var twoId = twoOption.GetAttribute("id");

        // Act - Simulate dropdown change with the ID of the "Two" option
        await cut.FindComponent<FluentListbox<string, string>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            SelectedOptions = twoId,
        });

        // Assert
        Assert.True(valueChangedCalled, "ValueChanged should have been invoked");
        Assert.Equal("Two", selectedValue);
    }

    [Fact]
    public async Task FluentListbox_Manual_OnDropdownChange_EmptySelection()
    {
        string? selectedValue = "One";
        var valueChangedCalled = false;

        // Arrange - Using manual FluentOptionString elements (no Items collection)
        var cut = Render(@<FluentListbox TOption="string" TValue="string" Value="@selectedValue" ValueChanged="@(v => { selectedValue = v; valueChangedCalled = true; })">
            <FluentOptionString Value="One">One</FluentOptionString>
            <FluentOptionString Value="Two">Two</FluentOptionString>
        </FluentListbox>);

        // Act - Simulate dropdown change with empty selection
        await cut.FindComponent<FluentListbox<string, string>>().Instance.OnDropdownChangeHandlerAsync(new DropdownEventArgs
        {
            SelectedOptions = "",
        });

        // Assert - Value should be cleared to default
        Assert.True(valueChangedCalled, "ValueChanged should have been invoked");
        Assert.Null(selectedValue);
    }

    [Fact]
    public void FluentListbox_GetOptionValue_DefaultWhenTypesAreDifferent()
    {
        // Arrange - Create a scenario where TOption != TValue and no OptionValue function
        // Using a Person object as TOption and int as TValue
        var people = new[]
        {
            new Person { Id = 1, Name = "Alice" },
            new Person { Id = 2, Name = "Bob" }
        };

        // Act - This tests the GetOptionValue method path where typeof(TOption) != typeof(TValue)
        // and OptionValue is null, which should return default (0 for int)
        var cut = Render(@<FluentListbox Items="@people" TOption="Person" TValue="int" />);

        // Assert - No exception should be thrown, component renders correctly
        cut.Verify();
    }

    [Fact]
    public void FluentListbox_GetOptionValue_WithOptionValueFunc()
    {
        // Arrange - Create a scenario where TOption != TValue but OptionValue is provided
        var people = new[]
        {
            new Person { Id = 1, Name = "Alice" },
            new Person { Id = 2, Name = "Bob" }
        };

        int? selectedId = 1;

        // Act - This uses the OptionValue function to extract the value
        var cut = Render(@<FluentListbox 
            Items="@people" 
            TOption="Person" 
            TValue="int?" 
            Value="@selectedId"
            OptionValue="@(p => p?.Id)"
            OptionText="@(p => p?.Name)" />);

        // Assert - Alice should be selected
        var selectedOption = cut.Find("fluent-option[selected]");
        Assert.Equal("Alice", selectedOption.GetInnerText());
    }

    [Fact]
    public void FluentListbox_Width_And_Height()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" TOption="string" TValue="string" Width="200px" Height="300px" />);

        // Assert - Width and Height are applied to the listbox
        var listbox = cut.Find("fluent-listbox");
        var listboxStyle = listbox.GetAttribute("style");
        Assert.Contains("width: 200px", listboxStyle);
        Assert.Contains("height: 300px", listboxStyle);
    }

    [Fact]
    public void FluentListbox_Disabled()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" TOption="string" TValue="string" Disabled="true" />);

        // Assert
        var container = cut.Find("div.fluent-listbox");
        Assert.True(container.HasAttribute("disabled"));
    }

    [Fact]
    public void FluentListbox_ReadOnly()
    {
        // Arrange and Act
        var cut = Render(@<FluentListbox Items="@Digits" TOption="string" TValue="string" ReadOnly="true" />);

        // Assert
        var container = cut.Find("div.fluent-listbox");
        Assert.True(container.HasAttribute("readonly"));
    }

    public record Person
    {
        public int Id { get; set; }
        public string? Name { get; set; }
    }
}